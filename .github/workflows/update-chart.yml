name: Update Chart and Release

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

env:
  CHART_FILE: charts/nexus-repository-manager/Chart.yaml
  DOCKER_REPO: sonatype/nexus3

jobs:
  update-and-release:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      packages: write
      pages: write
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Get latest image tag from Docker Hub
        id: get_tag
        run: |
          set -euo pipefail

          echo "ğŸ” Fetching latest tags from Docker Hub..."

          RESPONSE=$(curl -fsSL \
            "https://registry.hub.docker.com/v2/repositories/${{ env.DOCKER_REPO }}/tags/?page_size=25&ordering=last_updated")

          if [ $? -ne 0 ]; then
            echo "âŒ Failed to fetch tags from Docker Hub"
            exit 1
          fi

          ALL_TAGS=$(echo "$RESPONSE" | jq -r '.results[].name')

          if [ -z "$ALL_TAGS" ]; then
            echo "âŒ No tags found in Docker Hub response"
            exit 1
          fi

          echo "ğŸ“‹ Available tags (first 25):"
          echo "$ALL_TAGS" | head -n 25

          # è¿‡æ»¤å‡ºç¬¦åˆè¯­ä¹‰åŒ–ç‰ˆæœ¬å·çš„æ ‡ç­¾ (x.y.z æ ¼å¼)
          # æ’é™¤ latest, dev, beta ç­‰éç‰ˆæœ¬å·æ ‡ç­¾
          SEMVER_TAGS=$(echo "$ALL_TAGS" | grep -E '^[0-9]+\.[0-9]+\.[0-9]+$' || true)

          if [ -z "$SEMVER_TAGS" ]; then
            echo "âš ï¸  No valid semantic version tags (x.y.z) found, skipping update"
            echo "should_skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "ğŸ“Œ Valid semantic version tags:"
          echo "$SEMVER_TAGS"

          # ä½¿ç”¨ sort -V è¿›è¡Œç‰ˆæœ¬å·æ’åºï¼Œè·å–æœ€æ–°ç‰ˆæœ¬
          LATEST_TAG=$(echo "$SEMVER_TAGS" | sort -V | tail -n1)

          if [ -z "$LATEST_TAG" ]; then
            echo "âš ï¸  Failed to determine latest version, skipping update"
            echo "should_skip=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "should_skip=false" >> $GITHUB_OUTPUT
          echo "âœ… Latest semantic version tag: $LATEST_TAG"

      - name: Check if update is needed
        id: check_update
        if: steps.get_tag.outputs.should_skip != 'true'
        run: |
          set -euo pipefail

          LATEST_TAG="${{ steps.get_tag.outputs.latest_tag }}"

          if [ ! -f "$CHART_FILE" ]; then
            echo "âŒ Chart file not found: $CHART_FILE"
            exit 1
          fi

          CURRENT_APP_VERSION=$(grep '^appVersion:' "$CHART_FILE" | awk '{print $2}' | tr -d '"' | tr -d "'")

          echo "ğŸ“Š Version comparison:"
          echo "  Current: $CURRENT_APP_VERSION"
          echo "  Latest:  $LATEST_TAG"

          if [ "$LATEST_TAG" = "$CURRENT_APP_VERSION" ]; then
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "âœ… Already up to date"
            exit 0
          fi

          # ä½¿ç”¨ç‰ˆæœ¬å·æ¯”è¾ƒå‡½æ•°
          compare_versions() {
            local ver1=$1
            local ver2=$2
            
            # ä½¿ç”¨ sort -V æ¯”è¾ƒç‰ˆæœ¬å·
            if [ "$(printf '%s\n%s' "$ver1" "$ver2" | sort -V | head -n1)" = "$ver1" ] && [ "$ver1" != "$ver2" ]; then
              return 1  # ver1 < ver2
            else
              return 0  # ver1 >= ver2
            fi
          }

          if compare_versions "$CURRENT_APP_VERSION" "$LATEST_TAG"; then
            echo "should_update=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸  Current version ($CURRENT_APP_VERSION) is equal to or newer than latest ($LATEST_TAG)"
          else
            echo "should_update=true" >> $GITHUB_OUTPUT
            echo "â¬†ï¸  Update available: $CURRENT_APP_VERSION -> $LATEST_TAG"
          fi

      - name: Update Chart.yaml
        id: update_chart
        if: steps.check_update.outputs.should_update == 'true'
        run: |
          set -euo pipefail

          NEW_APP_VERSION="${{ steps.get_tag.outputs.latest_tag }}"

          # è·å–å½“å‰ç‰ˆæœ¬å·
          CURRENT_CHART_VERSION=$(grep '^version:' "$CHART_FILE" | awk '{print $2}' | tr -d '"' | tr -d "'")
          CURRENT_APP_VERSION=$(grep '^appVersion:' "$CHART_FILE" | awk '{print $2}' | tr -d '"' | tr -d "'")

          echo "ğŸ“Š Current versions:"
          echo "  Chart version: $CURRENT_CHART_VERSION"
          echo "  App version:   $CURRENT_APP_VERSION"

          # è§£æå½“å‰ Chart ç‰ˆæœ¬å·
          CHART_MAJOR=$(echo "$CURRENT_CHART_VERSION" | cut -d. -f1)
          CHART_MINOR=$(echo "$CURRENT_CHART_VERSION" | cut -d. -f2)
          CHART_PATCH=$(echo "$CURRENT_CHART_VERSION" | cut -d. -f3)

          # è§£æå½“å‰å’Œæ–°çš„ App ç‰ˆæœ¬å·
          CURRENT_APP_MAJOR=$(echo "$CURRENT_APP_VERSION" | cut -d. -f1)
          CURRENT_APP_MINOR=$(echo "$CURRENT_APP_VERSION" | cut -d. -f2)
          CURRENT_APP_PATCH=$(echo "$CURRENT_APP_VERSION" | cut -d. -f3)

          NEW_APP_MAJOR=$(echo "$NEW_APP_VERSION" | cut -d. -f1)
          NEW_APP_MINOR=$(echo "$NEW_APP_VERSION" | cut -d. -f2)
          NEW_APP_PATCH=$(echo "$NEW_APP_VERSION" | cut -d. -f3)

          # ç¡®ä¿æ‰€æœ‰ç‰ˆæœ¬å·ç»„ä»¶éƒ½æœ‰å€¼
          CHART_MAJOR=${CHART_MAJOR:-0}
          CHART_MINOR=${CHART_MINOR:-0}
          CHART_PATCH=${CHART_PATCH:-0}

          # æ ¹æ® appVersion çš„å˜åŒ–ç±»å‹ï¼ŒåŒæ­¥å‡çº§ Chart ç‰ˆæœ¬å·
          if [ "$NEW_APP_MAJOR" -gt "$CURRENT_APP_MAJOR" ]; then
            # Major ç‰ˆæœ¬å‡çº§
            NEW_CHART_MAJOR=$((CHART_MAJOR + 1))
            NEW_CHART_MINOR=0
            NEW_CHART_PATCH=0
            VERSION_TYPE="MAJOR"
            echo "ğŸš€ Detected MAJOR version bump in appVersion"
          elif [ "$NEW_APP_MINOR" -gt "$CURRENT_APP_MINOR" ]; then
            # Minor ç‰ˆæœ¬å‡çº§
            NEW_CHART_MAJOR=$CHART_MAJOR
            NEW_CHART_MINOR=$((CHART_MINOR + 1))
            NEW_CHART_PATCH=0
            VERSION_TYPE="MINOR"
            echo "ğŸ“ˆ Detected MINOR version bump in appVersion"
          elif [ "$NEW_APP_PATCH" -gt "$CURRENT_APP_PATCH" ]; then
            # Patch ç‰ˆæœ¬å‡çº§
            NEW_CHART_MAJOR=$CHART_MAJOR
            NEW_CHART_MINOR=$CHART_MINOR
            NEW_CHART_PATCH=$((CHART_PATCH + 1))
            VERSION_TYPE="PATCH"
            echo "ğŸ”§ Detected PATCH version bump in appVersion"
          else
            # ç†è®ºä¸Šä¸åº”è¯¥åˆ°è¿™é‡Œï¼Œå› ä¸ºå‰é¢å·²ç»æ£€æŸ¥è¿‡ç‰ˆæœ¬
            NEW_CHART_MAJOR=$CHART_MAJOR
            NEW_CHART_MINOR=$CHART_MINOR
            NEW_CHART_PATCH=$((CHART_PATCH + 1))
            VERSION_TYPE="PATCH"
            echo "âš ï¸  Fallback to PATCH version bump"
          fi

          NEW_CHART_VERSION="${NEW_CHART_MAJOR}.${NEW_CHART_MINOR}.${NEW_CHART_PATCH}"

          echo ""
          echo "ğŸ“¦ Version update summary:"
          echo "  Chart: $CURRENT_CHART_VERSION -> $NEW_CHART_VERSION ($VERSION_TYPE)"
          echo "  App:   $CURRENT_APP_VERSION -> $NEW_APP_VERSION ($VERSION_TYPE)"

          # æ›´æ–° Chart.yaml æ–‡ä»¶
          sed -i "s|^version:.*|version: $NEW_CHART_VERSION|" "$CHART_FILE"
          sed -i "s|^appVersion:.*|appVersion: $NEW_APP_VERSION|" "$CHART_FILE"

          echo "new_version=$NEW_CHART_VERSION" >> $GITHUB_OUTPUT
          echo "new_app_version=$NEW_APP_VERSION" >> $GITHUB_OUTPUT
          echo "version_type=$VERSION_TYPE" >> $GITHUB_OUTPUT

          echo ""
          echo "âœ… Updated $CHART_FILE:"
          grep -E '^(version|appVersion):' "$CHART_FILE"

      - name: Commit and push changes
        if: steps.check_update.outputs.should_update == 'true'
        run: |
          set -euo pipefail

          # ä¿å­˜å½“å‰ç‰ˆæœ¬å·ç”¨äº commit message
          CURRENT_CHART_VERSION=$(grep '^version:' "$CHART_FILE" | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")
          CURRENT_APP_VERSION=$(grep '^appVersion:' "$CHART_FILE" | head -1 | awk '{print $2}' | tr -d '"' | tr -d "'")

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add "$CHART_FILE"

          if git diff --staged --quiet; then
            echo "â„¹ï¸  No changes to commit"
            exit 0
          fi

          git commit -m "chore(chart): bump nexus-repository-manager to ${{ steps.update_chart.outputs.new_app_version }} (${{ steps.update_chart.outputs.version_type }})" \
            -m "- Update appVersion: $CURRENT_APP_VERSION -> ${{ steps.update_chart.outputs.new_app_version }}" \
            -m "- Bump chart version: $CURRENT_CHART_VERSION -> ${{ steps.update_chart.outputs.new_version }}" \
            -m "- Version type: ${{ steps.update_chart.outputs.version_type }}"

          git push

          echo "âœ… Changes committed and pushed"

      - name: Set up Helm
        if: steps.check_update.outputs.should_update == 'true'
        uses: azure/setup-helm@v4
        with:
          version: 'latest'

      - name: Run chart-releaser
        if: steps.check_update.outputs.should_update == 'true'
        uses: helm/chart-releaser-action@v1.6.0
        with:
          charts_dir: charts
        env:
          CR_TOKEN: "${{ secrets.GITHUB_TOKEN }}"

      - name: Summary
        if: steps.check_update.outputs.should_update == 'true'
        run: |
          # ä» git log è·å–ä¹‹å‰çš„ç‰ˆæœ¬å·
          PREV_CHART_VERSION=$(git show HEAD~1:$CHART_FILE | grep '^version:' | awk '{print $2}' | tr -d '"' | tr -d "'")
          PREV_APP_VERSION=$(git show HEAD~1:$CHART_FILE | grep '^appVersion:' | awk '{print $2}' | tr -d '"' | tr -d "'")
          
          echo "## ğŸ‰ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Version Updates (${{ steps.update_chart.outputs.version_type }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Type | Previous | New |" >> $GITHUB_STEP_SUMMARY
          echo "|------|----------|-----|" >> $GITHUB_STEP_SUMMARY
          echo "| Chart Version | \`${PREV_CHART_VERSION}\` | \`${{ steps.update_chart.outputs.new_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| App Version | \`${PREV_APP_VERSION}\` | \`${{ steps.update_chart.outputs.new_app_version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Chart has been released successfully!" >> $GITHUB_STEP_SUMMARY

      - name: No update summary
        if: steps.get_tag.outputs.should_skip == 'true' || steps.check_update.outputs.should_update == 'false'
        run: |
          echo "## â„¹ï¸  No Update Required" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.get_tag.outputs.should_skip }}" = "true" ]; then
            echo "No valid semantic version tags (x.y.z) found in Docker Hub." >> $GITHUB_STEP_SUMMARY
          else
            echo "Chart is already up to date." >> $GITHUB_STEP_SUMMARY
          fi
